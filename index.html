<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLEX ‚Äî Mikra + Chaya</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg:#0c0c0e;--card:#161618;--card2:#1e1e21;--border:#2a2a2e;
            --text:#e8e8ec;--text2:#8e8e96;--text3:#56565e;
            --accent:#f0c000;--blue:#4a9eff;
            --purple:#a855f7;--cyan:#22d3ee;--green:#34d399;--red:#f87171;--orange:#fb923c;
            --radius:10px;--font:'DM Sans',system-ui,sans-serif;
        }
        body{font-family:var(--font);background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;overflow-x:hidden}
        a{color:var(--blue);text-decoration:none}
        a:hover{text-decoration:underline}

        /* HEADER */
        .header{position:sticky;top:0;z-index:100;background:var(--bg);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:8px;backdrop-filter:blur(20px)}
        .header-left{display:flex;align-items:center;gap:10px}
        .logo{font-size:15px;font-weight:700;letter-spacing:-.02em;color:var(--accent)}
        .badges{display:flex;gap:6px;flex-wrap:wrap}
        .badge{font-size:11px;font-weight:600;padding:3px 8px;border-radius:20px;background:var(--card2);color:var(--text2);border:1px solid var(--border);white-space:nowrap}
        .badge.fecha{color:var(--orange);border-color:rgba(251,146,60,.25)}
        .badge.caba{color:var(--purple);border-color:rgba(168,85,247,.25)}
        .badge.prov{color:var(--cyan);border-color:rgba(34,211,238,.25)}
        .header-actions{display:flex;gap:6px}
        .icon-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15s}
        .icon-btn:hover{border-color:var(--text3);color:var(--text);background:var(--card2)}
        .icon-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(240,192,0,.08)}

        /* TOOLS DRAWER */
        .drawer{max-height:0;overflow:hidden;transition:max-height .3s ease;background:var(--card);border-bottom:1px solid var(--border)}
        .drawer.open{max-height:300px}
        .drawer-inner{padding:12px 16px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
        .drawer-btn{font-family:var(--font);font-size:12px;font-weight:600;padding:7px 14px;border-radius:8px;border:1px solid var(--border);background:var(--card2);color:var(--text2);cursor:pointer;transition:all .15s;white-space:nowrap}
        .drawer-btn:hover{border-color:var(--text3);color:var(--text)}
        .drawer-btn.warn{border-color:rgba(251,146,60,.3);color:var(--orange)}
        .drawer-btn.purple{border-color:rgba(168,85,247,.3);color:var(--purple)}
        .drawer-sep{width:1px;height:24px;background:var(--border);margin:0 4px}
        input[type=date]{font-family:var(--font);font-size:12px;padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:var(--card2);color:var(--text);cursor:pointer;color-scheme:dark}

        /* STATS ROW */
        .stats-row{display:flex;gap:2px;padding:10px 16px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
        .stats-row::-webkit-scrollbar{display:none}
        .stat-chip{flex-shrink:0;padding:8px 14px;border-radius:8px;background:var(--card);border:1px solid transparent;cursor:pointer;text-align:center;transition:all .15s;min-width:60px}
        .stat-chip:hover{background:var(--card2)}
        .stat-chip.active{border-color:var(--accent);background:rgba(240,192,0,.06)}
        .stat-num{font-size:20px;font-weight:700;line-height:1}
        .stat-label{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text3);margin-top:3px}
        .stat-chip[data-s="all"] .stat-num{color:var(--accent)}
        .stat-chip[data-s="pendiente"] .stat-num{color:var(--purple)}
        .stat-chip[data-s="en-camino"] .stat-num{color:var(--cyan)}
        .stat-chip[data-s="entregado"] .stat-num{color:var(--green)}
        .stat-chip[data-s="reprogramado"] .stat-num{color:var(--orange)}

        /* PROGRESS BAR */
        .progress{height:4px;background:var(--card);margin:0 16px 6px;border-radius:4px;overflow:hidden;display:flex}
        .prog-seg{height:100%;transition:width .4s}
        .prog-seg.pendiente{background:var(--purple)}
        .prog-seg.en-camino{background:var(--cyan)}
        .prog-seg.entregado{background:var(--green)}
        .prog-seg.reprogramado{background:var(--orange)}

        /* FILTER BAR */
        .filter-bar{padding:6px 16px 10px;display:flex;gap:6px;flex-wrap:wrap;align-items:center}
        .pill{font-family:var(--font);font-size:11px;font-weight:600;padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:var(--card);color:var(--text2);cursor:pointer;transition:all .15s;white-space:nowrap}
        .pill:hover{border-color:var(--text3)}
        .pill.active{color:#fff}
        .pill.all.active{background:var(--blue);border-color:var(--blue)}
        .pill.mikra.active{background:var(--purple);border-color:var(--purple)}
        .pill.chaya.active{background:var(--orange);border-color:var(--orange)}
        .pill.cancel{color:var(--red);border-color:rgba(248,113,113,.2)}
        .pill.cancel.active{background:var(--red);border-color:var(--red);color:#fff}
        .pill-count{font-size:10px;opacity:.7;margin-left:3px}

        /* ZONE SELECT */
        .zone-select-wrap{position:relative;flex:1;min-width:180px;max-width:300px}
        .zone-trigger{font-family:var(--font);width:100%;padding:6px 30px 6px 12px;font-size:12px;font-weight:500;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;text-align:left;appearance:none;position:relative}
        .zone-trigger::after{content:'‚ñæ';position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none}
        .zone-dd{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--card);border:1px solid var(--accent);border-radius:8px;max-height:260px;overflow-y:auto;z-index:200;display:none}
        .zone-dd.open{display:block}
        .zone-dd input{width:calc(100% - 16px);margin:8px;padding:6px 10px;background:var(--card2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;font-family:var(--font)}
        .zone-dd-item{padding:8px 12px;font-size:12px;cursor:pointer;border-bottom:1px solid var(--border);color:var(--text2);transition:background .1s}
        .zone-dd-item:hover{background:var(--card2);color:var(--text)}
        .zone-dd-item:last-child{border-bottom:none}

        /* SORT ROW */
        .sort-row{padding:0 16px 8px;display:flex;gap:4px;align-items:center;flex-wrap:wrap}
        .sort-label{font-size:11px;color:var(--text3);font-weight:600;margin-right:4px}
        .sort-btn{font-family:var(--font);font-size:11px;font-weight:500;padding:4px 10px;border-radius:6px;border:1px solid transparent;background:transparent;color:var(--text3);cursor:pointer;transition:all .15s}
        .sort-btn:hover{color:var(--text2)}
        .sort-btn.active{background:var(--accent);color:#000;font-weight:600}

        /* CONTENT */
        .content{padding:0 16px 100px}

        /* CARDS */
        .card{background:var(--card);border-radius:var(--radius);padding:14px 16px;margin-bottom:8px;border-left:3px solid var(--border);cursor:pointer;transition:background .15s;position:relative}
        .card:hover{background:var(--card2)}
        .card:active{background:var(--card2)}
        .card.pendiente{border-left-color:var(--purple)}
        .card.en-camino{border-left-color:var(--cyan)}
        .card.entregado{border-left-color:var(--green)}
        .card.cancelado{border-left-color:var(--red);opacity:.6}
        .card.reprogramado{border-left-color:var(--orange)}

        .card-top{display:flex;justify-content:space-between;align-items:center;gap:8px}
        .card-zona{font-size:14px;font-weight:600;color:var(--accent);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .card-estado{font-size:11px;font-weight:600;padding:4px 10px;border-radius:20px;white-space:nowrap;flex-shrink:0}
        .card-estado.pendiente{background:rgba(168,85,247,.15);color:var(--purple)}
        .card-estado.en-camino{background:rgba(34,211,238,.15);color:var(--cyan)}
        .card-estado.entregado{background:rgba(52,211,153,.15);color:var(--green)}
        .card-estado.cancelado{background:rgba(248,113,113,.15);color:var(--red)}
        .card-estado.reprogramado{background:rgba(251,146,60,.15);color:var(--orange)}

        .card-cuenta{position:absolute;top:14px;right:16px;width:8px;height:8px;border-radius:50%}
        .card-cuenta.mikra{background:var(--purple)}
        .card-cuenta.chaya{background:var(--orange)}

        /* EXPANDED DETAILS */
        .card-details{max-height:0;overflow:hidden;transition:max-height .25s ease}
        .card-details.open{max-height:600px}
        .card-detail-inner{padding-top:12px;border-top:1px solid var(--border);margin-top:12px}
        .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .detail-item{background:var(--bg);padding:8px 10px;border-radius:6px}
        .detail-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--text3);margin-bottom:2px}
        .detail-val{font-size:13px;color:var(--text)}
        .detail-val.hoy{color:var(--orange);font-weight:600}

        /* TIMELINE */
        .timeline{display:flex;gap:4px;margin-top:10px;align-items:center}
        .tl-step{flex:1;text-align:center}
        .tl-dot{width:10px;height:10px;border-radius:50%;margin:0 auto 3px;border:2px solid var(--border)}
        .tl-dot.done{background:var(--green);border-color:var(--green);box-shadow:0 0 6px rgba(52,211,153,.4)}
        .tl-line{flex:0 0 20px;height:2px;background:var(--border);margin-bottom:14px}
        .tl-line.done{background:var(--green)}
        .tl-text{font-size:9px;color:var(--text3)}
        .tl-time{font-size:11px;font-weight:600;color:var(--green)}
        .tl-time.pending{color:var(--text3);font-weight:400}

        /* TRACKING */
        .tracking{background:var(--bg);border-radius:6px;padding:8px 10px;margin-top:8px;border-left:2px solid var(--blue)}
        .tracking-title{font-size:10px;font-weight:600;color:var(--text3);margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em}
        .track-ev{display:flex;gap:6px;align-items:flex-start;padding:3px 0;font-size:11px;color:var(--text2)}
        .track-dot{width:6px;height:6px;border-radius:50%;margin-top:4px;flex-shrink:0}
        .track-dot.shipped{background:var(--cyan)}
        .track-dot.near{background:var(--accent)}
        .track-dot.absent{background:var(--red)}
        .track-dot.retry{background:var(--orange)}
        .track-dot.delivered{background:var(--green)}
        .track-dot.default{background:var(--text3)}
        .track-ev.highlight-absent{color:var(--red)}
        .track-ev.highlight-near{color:var(--accent)}

        .rep-badge{font-size:10px;font-weight:600;padding:3px 8px;border-radius:10px;display:inline-flex;align-items:center;gap:3px;margin-top:6px}
        .rep-badge.warn{background:rgba(248,113,113,.15);color:var(--red)}
        .rep-badge.ok{background:rgba(52,211,153,.1);color:var(--green)}

        .card-sub{display:flex;gap:6px;align-items:center;margin-top:5px;flex-wrap:wrap}
        .card-name{font-size:12px;color:var(--text2);font-weight:500}
        .card-comment{font-size:11px;color:var(--orange);font-style:italic;background:rgba(251,146,60,.08);padding:2px 6px;border-radius:4px;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .card-items-badge{font-size:10px;font-weight:600;color:var(--accent);background:rgba(240,192,0,.1);padding:2px 6px;border-radius:4px}
        .money-row{display:flex;gap:12px;align-items:center;margin-top:6px;flex-wrap:wrap}
        .money-tag{font-size:11px;font-weight:600;padding:3px 8px;border-radius:6px}
        .money-tag.venta{background:rgba(52,211,153,.1);color:var(--green)}
        .money-tag.fee{background:rgba(248,113,113,.08);color:var(--red)}
        .money-tag.neto{background:rgba(74,158,255,.1);color:var(--blue)}
        .summary-banner{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;margin:0 16px 10px;display:flex;gap:16px;flex-wrap:wrap;align-items:center;justify-content:center}
        .summary-item{text-align:center}
        .summary-val{font-size:18px;font-weight:700}
        .summary-label{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--text3);margin-top:1px}
        .card-links{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
        .card-link{font-size:11px;font-weight:500;padding:5px 10px;border-radius:6px;background:var(--bg);border:1px solid var(--border);color:var(--text2);transition:all .15s;display:inline-flex;align-items:center;gap:4px}
        .card-link:hover{border-color:var(--blue);color:var(--blue);text-decoration:none}

        /* LOADING / ERROR / EMPTY */
        .loading-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;color:var(--text2)}
        .spinner{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:12px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-text{font-size:13px}
        .error-box{background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.2);color:var(--red);padding:20px;border-radius:var(--radius);text-align:center;font-size:14px}
        .empty-state{text-align:center;padding:40px 20px;color:var(--text3);font-size:14px}

        /* MAP MODAL */
        .map-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:500;overflow:auto;backdrop-filter:blur(4px)}
        .map-overlay.open{display:block}
        .map-wrap{max-width:1100px;margin:16px auto;padding:16px;background:var(--card);border-radius:12px}
        .map-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .map-head h2{font-size:16px;color:var(--accent);font-weight:600}
        .map-close{font-family:var(--font);font-size:13px;font-weight:600;padding:6px 14px;border-radius:8px;border:1px solid var(--red);background:transparent;color:var(--red);cursor:pointer;transition:all .15s}
        .map-close:hover{background:var(--red);color:#fff}
        .map-filters{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
        .mf-btn{font-family:var(--font);font-size:11px;font-weight:600;padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:var(--card2);color:var(--text3);cursor:pointer;transition:all .15s}
        .mf-btn.on-camino{border-color:var(--cyan);color:var(--cyan);background:rgba(34,211,238,.08)}
        .mf-btn.on-reprog{border-color:var(--orange);color:var(--orange);background:rgba(251,146,60,.08)}
        .mf-btn.on-entreg{border-color:var(--green);color:var(--green);background:rgba(52,211,153,.08)}
        #mapFrame{width:100%;height:65vh;border-radius:8px;background:var(--bg)}
        .leaflet-popup-content-wrapper{background:var(--card);color:var(--text);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.5)}
        .leaflet-popup-tip{background:var(--card)}
        .leaflet-container a.leaflet-popup-close-button{color:var(--text2)}

        /* REPROGRAMADOS VIEW */
        .reprog-banner{background:rgba(251,146,60,.1);border:1px solid rgba(251,146,60,.2);color:var(--orange);padding:12px 16px;border-radius:var(--radius);text-align:center;font-weight:600;font-size:14px;margin-bottom:12px}

        .hidden{display:none!important}

        @media(max-width:600px){
            .detail-grid{grid-template-columns:1fr}
            .badges{display:none}
            .header .badges-mobile{display:flex}
            .map-wrap{margin:8px;padding:10px}
            #mapFrame{height:55vh}
        }
    </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <div class="header-left">
        <span class="logo">üèçÔ∏è FLEX</span>
        <div class="badges" id="infoBadges" style="display:none">
            <span class="badge fecha" id="badgeFecha">HOY</span>
            <span class="badge caba" id="badgeCaba">CABA: 0</span>
            <span class="badge prov" id="badgeProvincia">Prov: 0</span>
        </div>
    </div>
    <div class="header-actions">
        <button class="icon-btn hidden" id="btnMapa" onclick="mostrarMapa()" title="Mapa">üó∫Ô∏è</button>
        <button class="icon-btn" id="toolsToggle" onclick="toggleTools()" title="Herramientas">‚öôÔ∏è</button>
    </div>
</div>

<!-- TOOLS DRAWER -->
<div class="drawer" id="toolsPanel">
    <div class="drawer-inner">
        <button class="drawer-btn warn" onclick="cargarFlexDiaAnterior()" id="loadAyerBtn">üìÖ <span id="diaAnteriorLabel"></span></button>
        <div class="drawer-sep"></div>
        <input type="date" id="fechaCustom">
        <button class="drawer-btn purple" onclick="cargarFechaCustom()">Buscar fecha</button>
        <div class="drawer-sep"></div>
        <div class="pill all active" onclick="filtrarPorCuenta('all')">Todas <span class="pill-count" id="allCount">0</span></div>
        <div class="pill mikra" onclick="filtrarPorCuenta('Mikra')">Mikra <span class="pill-count" id="mikraCount">0</span></div>
        <div class="pill chaya" onclick="filtrarPorCuenta('Chaya')">Chaya <span class="pill-count" id="chayaCount">0</span></div>
        <div class="pill cancel" onclick="toggleCanceladas()" id="toggleCanceladasBtn" style="display:none">‚úï Cancel <span class="pill-count" id="canceladasCount">0</span></div>
    </div>
</div>

<!-- STATS -->
<div id="statsSection" class="hidden">
    <div class="stats-row">
        <div class="stat-chip active" data-s="all" onclick="filtrarPorEstado('all')" id="stat-all">
            <div class="stat-num">0</div><div class="stat-label">Todos</div>
        </div>
        <div class="stat-chip" data-s="pendiente" onclick="filtrarPorEstado('pendiente')" id="stat-pendiente">
            <div class="stat-num">0</div><div class="stat-label">Pend</div>
        </div>
        <div class="stat-chip" data-s="en-camino" onclick="filtrarPorEstado('en-camino')" id="stat-en-camino">
            <div class="stat-num">0</div><div class="stat-label">Camino</div>
        </div>
        <div class="stat-chip" data-s="entregado" onclick="filtrarPorEstado('entregado')" id="stat-entregado">
            <div class="stat-num">0</div><div class="stat-label">Entreg</div>
        </div>
        <div class="stat-chip" data-s="reprogramado" onclick="filtrarPorEstado('reprogramado')" id="stat-reprogramado">
            <div class="stat-num">0</div><div class="stat-label">Reprog</div>
        </div>
    </div>
    <div class="progress" id="progressBar"></div>
</div>

<!-- FILTERS -->
<div id="filterSection" class="hidden">
    <div class="filter-bar">
        <div class="zone-select-wrap" id="zoneSelectWrap">
            <button class="zone-trigger" onclick="toggleDropdown()">
                <span id="selectedZone">Todas las zonas</span>
            </button>
            <div id="dropdownMenu" class="zone-dd">
                <input type="text" id="dropdownSearch" placeholder="Buscar zona‚Ä¶" oninput="filtrarDropdown()">
                <div id="dropdownItems"></div>
            </div>
        </div>
    </div>
</div>

<!-- SORT -->
<div id="sortSection" class="sort-row hidden">
    <span class="sort-label">Ordenar:</span>
    <button class="sort-btn active" onclick="ordenarPor('zona',this)">Zona</button>
    <button class="sort-btn" onclick="ordenarPor('fecha-entrega',this)">Fecha</button>
    <button class="sort-btn" onclick="ordenarPor('hora-entrega',this)">Hora</button>
    <button class="sort-btn" onclick="ordenarPor('estado',this)">Estado</button>
    <button class="sort-btn" onclick="ordenarPor('recientes',this)">Recientes</button>
</div>

<!-- CONTENT -->
<div class="content" id="content"></div>

<!-- MAP MODAL -->
<div id="mapModal" class="map-overlay">
    <div class="map-wrap">
        <div class="map-head">
            <h2>Mapa de Entregas</h2>
            <button class="map-close" onclick="cerrarMapa()">‚úï Cerrar</button>
        </div>
        <div class="map-filters">
            <button class="mf-btn on-camino" onclick="toggleMapFilter('en-camino')" id="mapFilterEnCamino">
                üöö En camino (<span id="mapCountEnCamino">0</span>)
            </button>
            <button class="mf-btn on-reprog" onclick="toggleMapFilter('reprogramado')" id="mapFilterReprogramado">
                üîÑ Reprog (<span id="mapCountReprogramado">0</span>)
            </button>
            <button class="mf-btn on-entreg" onclick="toggleMapFilter('entregado')" id="mapFilterEntregado">
                ‚úÖ Entreg (<span id="mapCountEntregado">0</span>)
            </button>
        </div>
        <div id="mapFrame"></div>
    </div>
</div>

<script>
// === CONFIG ===
const CUENTAS = [
    { nombre: 'Mikra', clientId: '6723747350775490', proxy: 'https://mikra-flex-proxy.rafaelassir.workers.dev', color: 'mikra' },
    { nombre: 'Chaya', clientId: '1942700449315778', proxy: 'https://chaya-flex-proxy.rafaelassir.workers.dev', color: 'chaya' }
];

let allFlexOrders = [];
let currentStateFilter = 'all';
let currentZoneFilter = 'all';
let currentCuentaFilter = 'all';
let mostrarCanceladas = false;
let currentSort = 'zona';
let dropdownOpen = false;
let vistaSimple = true;

const BARRIOS_CABA = [
    'Agronom√≠a','Almagro','Balvanera','Barracas','Belgrano','Boedo',
    'Caballito','Chacarita','Coghlan','Colegiales','Constituci√≥n',
    'Flores','Floresta','La Boca','Liniers','Mataderos',
    'Monte Castro','Monserrat','Nueva Pompeya','N√∫√±ez','Palermo',
    'Parque Avellaneda','Parque Chacabuco','Parque Patricios','Paternal',
    'Recoleta','Retiro','Saavedra','San Crist√≥bal','San Nicol√°s',
    'San Telmo','Velez Sarsfield','Versailles','Villa Crespo',
    'Villa Devoto','Villa General Mitre','Villa Lugano','Villa Luro',
    'Villa Ort√∫zar','Villa Pueyrredon','Villa Pueyrred√≥n','Villa Real',
    'Villa Santa Rita','Villa Urquiza'
];

function normalizar(t){return t.toLowerCase().trim().replace(/√°/g,'a').replace(/√©/g,'e').replace(/√≠/g,'i').replace(/√≥/g,'o').replace(/√∫/g,'u').replace(/√±/g,'n')}
function esBarrioCABA(n){const nn=normalizar(n);return BARRIOS_CABA.some(b=>normalizar(b)===nn)}
function esCABAPorCP(z){if(!z)return false;const c=parseInt(String(z).replace(/\D/g,''),10);return!isNaN(c)&&c>=1000&&c<=1499}

function getZonaDetallada(barrio,ciudad,zipCode){
    const b=(barrio||'').trim(),c=(ciudad||'').trim();
    const esCABAn=c==='CABA'||b==='CABA'||c==='Buenos aires'||c==='Capital Federal'||esBarrioCABA(b)||esBarrioCABA(c);
    const esCABAcp=esCABAPorCP(zipCode);
    if(esCABAn||esCABAcp){
        if(b&&b!=='CABA'&&b!=='Buenos aires'&&b!=='Capital Federal')return`CABA - ${b}`;
        if(c&&c!=='CABA'&&c!=='Buenos aires'&&c!=='Capital Federal'&&esBarrioCABA(c))return`CABA - ${c}`;
        return'CABA - Otros';
    }
    const zN=['San Isidro','Vicente L√≥pez','San Fernando','Tigre','Olivos','Mart√≠nez','Acassuso','Beccar','La Lucila','Villa Adelina'];
    if(zN.some(z=>normalizar(z)===normalizar(c)||normalizar(z)===normalizar(b)))return`GBA Norte - ${c||b}`;
    const zO=['La Reja','Mor√≥n','Hurlingham','Ituzaing√≥','Ramos Mej√≠a','Ciudadela','Santos Lugares','Villa Luzuriaga','Luzuriaga','Ingeniero Allan','Castelar','El Palomar','Ciudad Jardin Del Palomar','Caseros','San Justo','san justo','Villa Sarmiento','villa sarmiento'];
    if(zO.some(z=>normalizar(z)===normalizar(c)||normalizar(z)===normalizar(b)))return`GBA Oeste - ${c||b}`;
    const zS=['Lomas de Zamora','Banfield','Lan√∫s','Avellaneda','Quilmes','Sarandi','Sarand√≠','Trist√°n Su√°rez','Carlos Spegazzini','Bernal Oeste','Temperley','Remedios De Escalada','Valentin Alsina','Berazategui','Florencio Varela','Wilde'];
    if(zS.some(z=>normalizar(z)===normalizar(c)||normalizar(z)===normalizar(b)))return`GBA Sur - ${c||b}`;
    const zI=['Z√°rate','Campana','La Plata','Mar del Plata','Bah√≠a Blanca'];
    if(zI.some(z=>normalizar(z)===normalizar(c)||normalizar(z)===normalizar(b)))return`Buenos Aires - ${c||b}`;
    return c||b||'Otras zonas';
}
function esCABA(z){return z.startsWith('CABA')}

// === UI CONTROLS ===
function toggleDropdown(){
    dropdownOpen=!dropdownOpen;
    const m=document.getElementById('dropdownMenu');
    if(dropdownOpen){m.classList.add('open');document.getElementById('dropdownSearch').focus()}
    else m.classList.remove('open');
}
function filtrarDropdown(){
    const s=normalizar(document.getElementById('dropdownSearch').value);
    document.querySelectorAll('.zone-dd-item').forEach(i=>{i.style.display=normalizar(i.textContent).includes(s)?'block':'none'});
}
function selectZone(z){
    currentZoneFilter=z;
    document.getElementById('selectedZone').textContent=z==='all'?'Todas las zonas':z.split('(')[0].trim();
    toggleDropdown();aplicarFiltros();
}
function toggleTools(){
    document.getElementById('toolsPanel').classList.toggle('open');
    document.getElementById('toolsToggle').classList.toggle('active');
}
function toggleVista(){
    vistaSimple=!vistaSimple;
    document.getElementById('toggleVistaBtn').textContent=vistaSimple?'Vista Completa':'Vista Simple';
    aplicarFiltros();
}
function toggleSimpleDetails(i){
    const d=document.getElementById(`det-${i}`);
    if(d)d.classList.toggle('open');
}

// === DATE HELPERS ===
function getDiaAnteriorLaborable(){
    const h=new Date();const d=h.getDay();
    let a=1;if(d===0)a=2;else if(d===1)a=3;else if(d===6)a=1;
    const r=new Date();r.setDate(r.getDate()-a);r.setHours(0,0,0,0);return r;
}
function actualizarLabelDiaAnterior(){
    const d=getDiaAnteriorLaborable();
    const dias=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
    document.getElementById('diaAnteriorLabel').textContent=dias[d.getDay()];
}
function formatearFecha(f){
    if(!f)return'‚Äî';const fecha=new Date(f),hoy=new Date();
    hoy.setHours(0,0,0,0);fecha.setHours(0,0,0,0);
    const diff=Math.floor((fecha-hoy)/(864e5));
    if(diff===0)return'Hoy';if(diff===-1)return'Ayer';if(diff===1)return'Ma√±ana';
    const d=['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
    return`${d[fecha.getDay()]} ${fecha.toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit'})}`;
}
function formatearSoloHora(f,fe){
    if(!f)return null;const fecha=new Date(f);
    if(fe){const e=new Date(fe);e.setHours(0,0,0,0);const a=new Date(f);a.setHours(0,0,0,0);
        if(e.getTime()!==a.getTime()){const d=['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
            return`${fecha.toLocaleString('es-AR',{timeZone:'America/Argentina/Buenos_Aires',hour:'2-digit',minute:'2-digit',hour12:false})} (${d[fecha.getDay()]})`;
        }
    }
    return fecha.toLocaleString('es-AR',{timeZone:'America/Argentina/Buenos_Aires',hour:'2-digit',minute:'2-digit',hour12:false});
}
function esEntregaParaFecha(s,t){
    const f=s.shipping_option?.estimated_delivery_time?.date||s.shipping_option?.estimated_delivery_final?.date;
    if(!f)return false;const e=new Date(f);e.setHours(0,0,0,0);return e.getTime()===t.getTime();
}

// === API ===
async function obtenerTokenCuenta(c){
    try{const r=await fetch(`${c.proxy}/get-token`);const d=await r.json();
        if(d.access_token){if(d.user_id&&!sessionStorage.getItem(`${c.nombre.toLowerCase()}_user_id`))sessionStorage.setItem(`${c.nombre.toLowerCase()}_user_id`,d.user_id);return d.access_token}
        return null;
    }catch(e){console.error(`Token error ${c.nombre}:`,e);return null}
}

// === STATE DETECTION ===
function getOrderState(s){
    const st=(s.status||'').toLowerCase(),sub=(s.substatus||'').toLowerCase(),h=s.status_history||{},tags=(s.tags||[]).map(t=>(t||'').toLowerCase());
    if(sub==='rescheduled'||sub==='rescheduled_by_buyer'||sub==='buyer_rescheduled'||sub==='delayed'||sub==='returning_to_sender'||sub==='waiting_for_withdrawal'||sub==='receiver_absent'||sub==='out_of_delivery_area'||sub==='not_delivered_and_returning'||sub==='delivery_failed'||tags.includes('rescheduled')||tags.includes('delayed')||tags.includes('return_to_sender'))return'reprogramado';
    if(st==='not_delivered'&&!sub.includes('cancel'))return'reprogramado';
    if(st==='cancelled'||sub==='cancelled'||sub==='buyer_cancelled'||sub==='cancelled_by_buyer'||sub==='cancelled_manually'||tags.includes('cancelled')||(st==='not_delivered'&&sub.includes('cancel')))return'cancelado';
    if(h.date_delivered)return'entregado';
    if(h.date_shipped)return'en-camino';
    return'pendiente';
}
function getReprogramadoDetail(s){
    const sub=(s.substatus||'').toLowerCase();
    if(sub==='receiver_absent')return{label:'Ausente',short:'Ausente'};
    if(sub==='buyer_rescheduled'||sub==='rescheduled_by_buyer'||sub==='rescheduled')return{label:'Reprog. comprador',short:'Reprogram.'};
    if(sub==='delayed')return{label:'Demorado',short:'Demorado'};
    if(sub==='returning_to_sender'||sub==='not_delivered_and_returning')return{label:'Devolviendo',short:'Devolviendo'};
    if(sub==='out_of_delivery_area')return{label:'Fuera de zona',short:'Fuera zona'};
    if(sub==='delivery_failed')return{label:'Entrega fallida',short:'Fallida'};
    if(sub==='waiting_for_withdrawal')return{label:'Esperando retiro',short:'Esp. retiro'};
    return{label:'Reprogramado',short:'Reprogramado'};
}

// === TRACKING ===
function classifyTrackingEvent(e){
    const l=(e.label||'').toLowerCase(),s=(e.substatus||'').toLowerCase();
    if(s==='receiver_absent'||l.includes('ausente'))return{icon:'absent',css:'highlight-absent'};
    if(s==='nearby'||s==='almost_there'||l.includes('muy cerca'))return{icon:'near',css:'highlight-near'};
    if(s==='rescheduled'||l.includes('nuevamente')||l.includes('reintento'))return{icon:'retry',css:''};
    if(s==='delivered'||l.includes('entregamos'))return{icon:'delivered',css:''};
    if(s==='in_transit'||s==='out_for_delivery'||s==='shipped'||l.includes('en camino'))return{icon:'shipped',css:''};
    if(s==='returning_to_sender'||s==='not_delivered_and_returning'||l.includes('devolv'))return{icon:'absent',css:'highlight-absent'};
    if(s==='delivery_failed'||l.includes('fallid'))return{icon:'absent',css:'highlight-absent'};
    return{icon:'default',css:''};
}
function renderTracking(s){
    const ev=s._trackingEvents;if(!ev||!ev.length)return'';
    let h='<div class="tracking"><div class="tracking-title">Historial</div>';
    ev.forEach(e=>{const c=classifyTrackingEvent(e);h+=`<div class="track-ev ${c.css}"><div class="track-dot ${c.icon}"></div><div>${e.label}</div></div>`});
    return h+'</div>';
}
function renderRepBadge(s){
    const p=s._problems;if(!p||!p.length)return'';
    return p.map(x=>x.reputationAffected?`<span class="rep-badge warn">‚ö† Rep. afectada (${x.type})</span>`:`<span class="rep-badge ok">‚úì Rep. ok (${x.type})</span>`).join('');
}
function formatDateShort(d){if(!d)return'';const f=new Date(d);return f.toLocaleString('es-AR',{timeZone:'America/Argentina/Buenos_Aires',day:'numeric',month:'short',hour:'2-digit',minute:'2-digit',hour12:false})}
function enrichShippingData(c,t,s,oid){
    const subH=s.substatus_history||[],h=s.status_history||{};let events=[];
    const labels={shipment_paid:'Preparando env√≠o',ready_to_ship:'Listo para enviar',picked_up:'Retirado',in_hub:'En centro distribuci√≥n',in_transit:'En camino',out_for_delivery:'En camino',nearby:'Muy cerca',almost_there:'Muy cerca',receiver_absent:'Comprador ausente',waiting_for_withdrawal:'Esperando retiro',delivered:'Entregado',returning_to_sender:'Devolviendo al vendedor',not_delivered_and_returning:'No entregado, devolviendo',rescheduled:'En camino nuevamente',rescheduled_by_buyer:'Reprogramado por comprador',buyer_rescheduled:'Reprogramado por comprador',delayed:'Demorado',out_of_delivery_area:'Fuera de zona',delivery_failed:'Entrega fallida',claimed_me:'Reclamo abierto',stolen:'Paquete robado',lost:'Extraviado',damaged:'Da√±ado',cancelled:'Cancelado',buyer_cancelled:'Cancelado por comprador',cancelled_by_buyer:'Cancelado por comprador'};
    if(subH.length>0)subH.forEach(e=>{const d=e.date?formatDateShort(e.date):'',l=labels[e.substatus]||e.substatus||e.status||'';if(l)events.push({label:`${d} | ${l}`,substatus:e.substatus})});
    if(h.date_shipped&&!events.some(e=>e.substatus==='in_transit'||e.substatus==='out_for_delivery'))events.push({label:`${formatDateShort(h.date_shipped)} | En camino`,substatus:'shipped'});
    if(h.date_delivered&&!events.some(e=>e.substatus==='delivered'))events.push({label:`${formatDateShort(h.date_delivered)} | Entregado`,substatus:'delivered'});
    if(h.date_not_delivered)events.push({label:`${formatDateShort(h.date_not_delivered)} | No entregado`,substatus:'not_delivered'});
    const seen=new Set();events=events.filter(e=>{if(seen.has(e.label))return false;seen.add(e.label);return true});
    if(events.length>0)s._trackingEvents=events;
    const probSubs=['delayed','delivery_failed','receiver_absent','lost','stolen','damaged'];
    const probs=[];
    if(s.status==='not_delivered'||probSubs.includes(s.substatus))probs.push({type:s.substatus||s.status,reputationAffected:false});
    if(probs.length>0)s._problems=probs;
}

// === LOAD DATA ===
async function cargarFlexHoy(){
    currentStateFilter='all';currentZoneFilter='all';currentCuentaFilter='all';mostrarCanceladas=false;allFlexOrders=[];
    const h=new Date();const d=h.getDay();let f=new Date(),l='HOY';
    if(d===0){f.setDate(f.getDate()+1);l='LUNES'}else if(d===6){f.setDate(f.getDate()+2);l='LUNES'}
    f.setHours(0,0,0,0);await cargarFlexPorFecha(f,l);
}
async function cargarFlexDiaAnterior(){
    currentStateFilter='all';currentZoneFilter='all';currentCuentaFilter='all';mostrarCanceladas=false;allFlexOrders=[];
    const d=getDiaAnteriorLaborable();const dias=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
    await cargarFlexPorFecha(d,dias[d.getDay()].toUpperCase());
}
async function cargarFechaCustom(){
    const i=document.getElementById('fechaCustom');if(!i.value){alert('Seleccion√° una fecha');return}
    currentStateFilter='all';currentZoneFilter='all';currentCuentaFilter='all';mostrarCanceladas=false;allFlexOrders=[];
    const p=i.value.split('-'),f=new Date(p[0],p[1]-1,p[2]);f.setHours(0,0,0,0);
    const dias=['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'],meses=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    await cargarFlexPorFecha(f,`${dias[f.getDay()]} ${f.getDate()} ${meses[f.getMonth()]}`);
}

async function cargarFlexPorFecha(targetDate,label){
    const content=document.getElementById('content');
    content.innerHTML=`<div class="loading-wrap"><div class="spinner"></div><div class="loading-text">Cargando ${label}‚Ä¶</div></div>`;
    let all=[];const seen=new Set();
    for(const cuenta of CUENTAS){
        try{const token=await obtenerTokenCuenta(cuenta);if(!token)continue;
            const orders=await cargarOrdenesDeCuenta(cuenta,token,targetDate);
            orders.forEach(item=>{const sid=item.shipping.id;if(!seen.has(sid)){seen.add(sid);all.push({...item,cuentaNombre:cuenta.nombre,cuentaColor:cuenta.color})}});
        }catch(e){console.error(`Error ${cuenta.nombre}:`,e)}
    }
    if(!all.length){content.innerHTML=`<div class="error-box">No hay env√≠os FLEX para ${label}</div>`;return}
    allFlexOrders=all.filter(({shipping})=>{const st=getOrderState(shipping);if(st==='cancelado')return esEntregaParaFecha(shipping,targetDate);return true});
    const zonaCounts=new Map();let cabaC=0,provC=0;
    allFlexOrders.forEach(({shipping})=>{const st=getOrderState(shipping);if(st==='cancelado')return;
        const z=getZonaDetallada(shipping.receiver_address?.neighborhood?.name||'',shipping.receiver_address?.city?.name||'',shipping.receiver_address?.zip_code||'');
        zonaCounts.set(z,(zonaCounts.get(z)||0)+1);esCABA(z)?cabaC++:provC++;
    });
    document.getElementById('badgeFecha').textContent=label;
    document.getElementById('badgeCaba').textContent=`CABA: ${cabaC}`;
    document.getElementById('badgeProvincia').textContent=`Prov: ${provC}`;
    document.getElementById('infoBadges').style.display='flex';
    const dd=document.getElementById('dropdownItems');
    const totalSC=allFlexOrders.filter(({shipping})=>getOrderState(shipping)!=='cancelado').length;
    dd.innerHTML=`<div class="zone-dd-item" onclick="selectZone('all')">Todas las zonas (${totalSC})</div>`;
    let cabaT=0;Array.from(zonaCounts.entries()).forEach(([z,c])=>{if(esCABA(z))cabaT+=c});
    if(cabaT>0)dd.innerHTML+=`<div class="zone-dd-item" onclick="selectZone('CABA')">CABA - Todos (${cabaT})</div>`;
    Array.from(zonaCounts.entries()).sort().forEach(([z,c])=>{dd.innerHTML+=`<div class="zone-dd-item" onclick="selectZone('${z}')">${z} (${c})</div>`});
    document.getElementById('filterSection').classList.remove('hidden');
    document.getElementById('statsSection').classList.remove('hidden');
    document.getElementById('sortSection').classList.remove('hidden');
    document.getElementById('btnMapa').classList.remove('hidden');
    displayOrders('all');
}

async function cargarOrdenesDeCuenta(cuenta,token,targetDate){
    let temp=[];const cKey=cuenta.nombre.toLowerCase();
    let sellerId=sessionStorage.getItem(`${cKey}_user_id`);
    if(!sellerId){try{const r=await fetch(`${cuenta.proxy}/get-token`);const d=await r.json();if(d.user_id){sellerId=d.user_id;sessionStorage.setItem(`${cKey}_user_id`,sellerId)}}catch(e){}}
    if(!sellerId)return[];
    const df=new Date(targetDate);df.setDate(df.getDate()-3);
    const dt=new Date(targetDate);dt.setDate(dt.getDate()+1);dt.setHours(23,59,59,0);
    const dfs=df.toISOString().split('.')[0]+'.000-00:00',dts=dt.toISOString().split('.')[0]+'.000-00:00';
    const dateFilter=`&order.date_created.from=${encodeURIComponent(dfs)}&order.date_created.to=${encodeURIComponent(dts)}`;
    const proms=[];for(let p=0;p<20;p++)proms.push(fetch(`${cuenta.proxy}/api/orders/search?seller=${sellerId}&offset=${p*50}&limit=50&sort=date_desc${dateFilter}`,{headers:{'Authorization':`Bearer ${token}`}}).then(r=>r.json()));
    const pages=await Promise.all(proms);const allO=pages.flatMap(d=>d.results||[]);
    const shipProms=allO.map(async o=>{try{const sid=o.shipping?.id;if(!sid)return null;
        const r=await fetch(`${cuenta.proxy}/api/shipments/${sid}`,{headers:{'Authorization':`Bearer ${token}`}});const s=await r.json();
        if(s.logistic_type==='self_service'){if(esEntregaParaFecha(s,targetDate)||s.status==='cancelled'||s.status==='not_delivered')return{order:o,shipping:s}}return null}catch(e){return null}});
    const res=await Promise.all(shipProms);temp=res.filter(Boolean);
    temp.forEach(({order,shipping})=>enrichShippingData(null,null,shipping,order.id));
    const uniq=new Map();temp.forEach(({order,shipping})=>{const sid=shipping.id;if(!uniq.has(sid))uniq.set(sid,{orders:[order],shipping});else uniq.get(sid).orders.push(order)});
    return Array.from(uniq.values());
}

// === FILTERS ===
function filtrarPorCuenta(c){
    currentCuentaFilter=c;
    document.querySelectorAll('.pill.all,.pill.mikra,.pill.chaya').forEach(e=>e.classList.remove('active'));
    document.querySelector(`.pill.${c==='all'?'all':c.toLowerCase()}`).classList.add('active');
    if(mostrarCanceladas){mostrarCanceladas=false;document.getElementById('toggleCanceladasBtn').classList.remove('active');currentStateFilter='all';
        document.querySelectorAll('.stat-chip').forEach(e=>e.classList.remove('active'));document.getElementById('stat-all').classList.add('active')}
    aplicarFiltros();
}
function toggleCanceladas(){
    mostrarCanceladas=!mostrarCanceladas;const b=document.getElementById('toggleCanceladasBtn');
    if(mostrarCanceladas){b.classList.add('active');currentStateFilter='cancelado';document.querySelectorAll('.stat-chip').forEach(e=>e.classList.remove('active'))}
    else{b.classList.remove('active');currentStateFilter='all';document.querySelectorAll('.stat-chip').forEach(e=>e.classList.remove('active'));document.getElementById('stat-all').classList.add('active')}
    aplicarFiltros();
}
function filtrarPorEstado(e){
    if(e!=='cancelado'){mostrarCanceladas=false;document.getElementById('toggleCanceladasBtn').classList.remove('active')}
    currentStateFilter=e;document.querySelectorAll('.stat-chip').forEach(el=>el.classList.remove('active'));
    if(document.getElementById(`stat-${e}`))document.getElementById(`stat-${e}`).classList.add('active');
    aplicarFiltros();
}
function ordenarPor(t,btn){
    currentSort=t;document.querySelectorAll('.sort-btn').forEach(e=>e.classList.remove('active'));if(btn)btn.classList.add('active');aplicarFiltros();
}
function aplicarFiltros(){
    let f=allFlexOrders;
    if(currentCuentaFilter!=='all')f=f.filter(({cuentaNombre})=>cuentaNombre===currentCuentaFilter);
    if(currentStateFilter==='cancelado')f=f.filter(({shipping})=>getOrderState(shipping)==='cancelado');
    else if(currentStateFilter==='all')f=f.filter(({shipping})=>getOrderState(shipping)!=='cancelado');
    else f=f.filter(({shipping})=>getOrderState(shipping)===currentStateFilter);
    if(currentZoneFilter!=='all')f=f.filter(({shipping})=>{
        const z=getZonaDetallada(shipping.receiver_address?.neighborhood?.name||'',shipping.receiver_address?.city?.name||'',shipping.receiver_address?.zip_code||'');
        return currentZoneFilter==='CABA'?esCABA(z):z===currentZoneFilter;
    });
    if(currentSort==='zona')f.sort((a,b)=>{const zA=getZonaDetallada(a.shipping.receiver_address?.neighborhood?.name||'',a.shipping.receiver_address?.city?.name||'',a.shipping.receiver_address?.zip_code||'');const zB=getZonaDetallada(b.shipping.receiver_address?.neighborhood?.name||'',b.shipping.receiver_address?.city?.name||'',b.shipping.receiver_address?.zip_code||'');return zA.localeCompare(zB)});
    else if(currentSort==='fecha-entrega')f.sort((a,b)=>(a.shipping.shipping_option?.estimated_delivery_time?.date||'').localeCompare(b.shipping.shipping_option?.estimated_delivery_time?.date||''));
    else if(currentSort==='hora-entrega')f.sort((a,b)=>{const tA=new Date(a.shipping.status_history?.date_delivered||a.shipping.status_history?.date_shipped||a.shipping.date_created||0).getTime();const tB=new Date(b.shipping.status_history?.date_delivered||b.shipping.status_history?.date_shipped||b.shipping.date_created||0).getTime();return tB-tA});
    else if(currentSort==='estado'){const o={cancelado:0,reprogramado:1,pendiente:2,'en-camino':3,entregado:4};f.sort((a,b)=>o[getOrderState(a.shipping)]-o[getOrderState(b.shipping)])}
    else if(currentSort==='recientes')f.sort((a,b)=>(b.shipping.date_created||'').localeCompare(a.shipping.date_created||''));
    displayOrders(currentStateFilter,f);
}

// === RENDER ===
function displayOrders(ft,custom=null){
    const orders=custom||allFlexOrders;
    let statsBase=allFlexOrders;
    if(currentCuentaFilter!=='all')statsBase=statsBase.filter(({cuentaNombre})=>cuentaNombre===currentCuentaFilter);
    const stats={pendiente:0,'en-camino':0,entregado:0,cancelado:0,reprogramado:0};
    statsBase.forEach(({shipping})=>stats[getOrderState(shipping)]++);
    stats.total=stats.pendiente+stats['en-camino']+stats.entregado+stats.reprogramado;

    const mikraC=allFlexOrders.filter(({cuentaNombre,shipping})=>cuentaNombre==='Mikra'&&getOrderState(shipping)!=='cancelado').length;
    const chayaC=allFlexOrders.filter(({cuentaNombre,shipping})=>cuentaNombre==='Chaya'&&getOrderState(shipping)!=='cancelado').length;
    const totalC=allFlexOrders.filter(({shipping})=>getOrderState(shipping)!=='cancelado').length;
    document.getElementById('allCount').textContent=totalC;
    document.getElementById('mikraCount').textContent=mikraC;
    document.getElementById('chayaCount').textContent=chayaC;

    document.querySelector('#stat-all .stat-num').textContent=stats.total;
    document.querySelector('#stat-pendiente .stat-num').textContent=stats.pendiente;
    document.querySelector('#stat-en-camino .stat-num').textContent=stats['en-camino'];
    document.querySelector('#stat-entregado .stat-num').textContent=stats.entregado;
    document.querySelector('#stat-reprogramado .stat-num').textContent=stats.reprogramado;
    document.getElementById('canceladasCount').textContent=stats.cancelado;
    document.getElementById('toggleCanceladasBtn').style.display=stats.cancelado>0?'inline-flex':'none';

    const tot=stats.total||1;
    document.getElementById('progressBar').innerHTML=
        (stats.pendiente?`<div class="prog-seg pendiente" style="width:${stats.pendiente/tot*100}%"></div>`:'')+
        (stats['en-camino']?`<div class="prog-seg en-camino" style="width:${stats['en-camino']/tot*100}%"></div>`:'')+
        (stats.entregado?`<div class="prog-seg entregado" style="width:${stats.entregado/tot*100}%"></div>`:'')+
        (stats.reprogramado?`<div class="prog-seg reprogramado" style="width:${stats.reprogramado/tot*100}%"></div>`:'');

    let html='';
    if(!orders.length){html='<div class="empty-state">Sin env√≠os con estos filtros</div>'}
    else{
        // Daily summary
        let sumVenta=0,sumFee=0,sumItems=0;
        orders.forEach(({orders:ol,shipping})=>{
            if(getOrderState(shipping)==='cancelado')return;
            ol.forEach(o=>{sumVenta+=o.total_amount||0;o.order_items.forEach(i=>{sumFee+=i.sale_fee||0;sumItems+=i.quantity||1})});
        });
        const sumNeto=sumVenta-sumFee;
        html+=`<div class="summary-banner">
            <div class="summary-item"><div class="summary-val" style="color:var(--accent)">${orders.length}</div><div class="summary-label">Env√≠os</div></div>
            <div class="summary-item"><div class="summary-val" style="color:var(--green)">$${Math.round(sumVenta).toLocaleString('es-AR')}</div><div class="summary-label">Venta</div></div>
            <div class="summary-item"><div class="summary-val" style="color:var(--red)">$${Math.round(sumFee).toLocaleString('es-AR')}</div><div class="summary-label">Fee ML</div></div>
            <div class="summary-item"><div class="summary-val" style="color:var(--blue)">$${Math.round(sumNeto).toLocaleString('es-AR')}</div><div class="summary-label">Neto</div></div>
            <div class="summary-item"><div class="summary-val" style="color:var(--text2)">${sumItems}</div><div class="summary-label">Items</div></div>
        </div>`;

        const estadoLabel={pendiente:'Pendiente','en-camino':'En camino',entregado:'Entregado',cancelado:'Cancelada',reprogramado:'Reprogramado'};
        orders.forEach(({orders:oList,shipping,cuentaNombre,cuentaColor},idx)=>{
            const state=getOrderState(shipping);
            const addr=shipping.receiver_address||{};
            const barrio=addr.neighborhood?.name||'';
            const ciudad=addr.city?.name||'';
            const zipCode=addr.zip_code||'';
            const zona=getZonaDetallada(barrio,ciudad,zipCode);
            const calle=addr.street_name||'';
            const num=addr.street_number||'';
            const prov=addr.state?.name||'';
            const dir=`${calle} ${num}, ${ciudad}, ${prov}`;
            const gmap=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dir)}`;
            const fe=shipping.shipping_option?.estimated_delivery_time?.date||shipping.shipping_option?.estimated_delivery_final?.date;
            const fechaF=formatearFecha(fe);const esHoy=fechaF==='Hoy';
            const hist=shipping.status_history||{};const fc=shipping.date_created;
            const estadoTexto=state==='reprogramado'?getReprogramadoDetail(shipping).label:estadoLabel[state];
            const comp=oList[0]?.buyer?.nickname||'N/A';
            const oid=oList[0]?.id||'';const oUrl=`https://www.mercadolibre.com.ar/ventas/${oid}/detalle`;

            // New data
            const receiverName=addr.receiver_name||'';
            const comment=(addr.comment||'').trim();
            const itemsShip=shipping.shipping_items?.length||oList.length;
            const totalVenta=oList.reduce((s,o)=>s+o.total_amount,0);
            const totalFee=oList.reduce((s,o)=>s+o.order_items.reduce((f,i)=>f+(i.sale_fee||0),0),0);
            const neto=totalVenta-totalFee;

            // Products list
            const productos=shipping.shipping_items?.map(i=>`${i.description} x${i.quantity}`).join(', ')||'';

            html+=`<div class="card ${state}" onclick="toggleSimpleDetails(${idx})">
                <div class="card-cuenta ${cuentaColor}" title="${cuentaNombre}"></div>
                <div class="card-top">
                    <div class="card-zona">${zona}</div>
                    <div class="card-estado ${state}">${estadoTexto}</div>
                </div>
                <div class="card-sub">
                    ${receiverName?`<span class="card-name">${receiverName}</span>`:''}
                    ${itemsShip>1?`<span class="card-items-badge">${itemsShip} items</span>`:''}
                    ${comment?`<span class="card-comment">${comment}</span>`:''}
                </div>
                <div class="card-details" id="det-${idx}">
                    <div class="card-detail-inner">
                        <div class="money-row">
                            <span class="money-tag venta">Venta $${Math.round(totalVenta).toLocaleString('es-AR')}</span>
                            <span class="money-tag fee">Fee $${Math.round(totalFee).toLocaleString('es-AR')}</span>
                            <span class="money-tag neto">Neto $${Math.round(neto).toLocaleString('es-AR')}</span>
                        </div>
                        ${productos?`<div style="margin-top:8px;font-size:11px;color:var(--text2);line-height:1.5">${shipping.shipping_items.map(i=>`<div>¬∑ ${i.description} <span style="color:var(--text3)">x${i.quantity}</span></div>`).join('')}</div>`:''}
                        <div class="detail-grid" style="margin-top:8px">
                            <div class="detail-item"><div class="detail-label">Direcci√≥n</div><div class="detail-val"><a href="${gmap}" target="_blank" onclick="event.stopPropagation()">${calle} ${num}, ${ciudad}</a></div></div>
                            <div class="detail-item"><div class="detail-label">Comprador</div><div class="detail-val">${comp}</div></div>
                            <div class="detail-item"><div class="detail-label">Entrega</div><div class="detail-val ${esHoy?'hoy':''}">${fechaF}</div></div>
                            <div class="detail-item"><div class="detail-label">Cuenta</div><div class="detail-val">${cuentaNombre}</div></div>
                        </div>
                        <div class="timeline">
                            <div class="tl-step"><div class="tl-dot done"></div><div class="tl-text">Recibida</div><div class="tl-time">${formatearSoloHora(fc,fe)||'‚Äî'}</div></div>
                            <div class="tl-line ${hist.date_shipped?'done':''}"></div>
                            <div class="tl-step"><div class="tl-dot ${hist.date_shipped?'done':''}"></div><div class="tl-text">Enviado</div><div class="tl-time ${hist.date_shipped?'':'pending'}">${formatearSoloHora(hist.date_shipped,fe)||'‚Äî'}</div></div>
                            <div class="tl-line ${hist.date_delivered?'done':''}"></div>
                            <div class="tl-step"><div class="tl-dot ${hist.date_delivered?'done':''}"></div><div class="tl-text">Entregado</div><div class="tl-time ${hist.date_delivered?'':'pending'}">${formatearSoloHora(hist.date_delivered,fe)||'‚Äî'}</div></div>
                        </div>
                        ${renderTracking(shipping)}
                        ${renderRepBadge(shipping)}
                        <div class="card-links">
                            <a href="${oUrl}" target="_blank" class="card-link" onclick="event.stopPropagation()">üìã #${oid}</a>
                            <a href="${gmap}" target="_blank" class="card-link" onclick="event.stopPropagation()">üìç Maps</a>
                        </div>
                    </div>
                </div>
            </div>`;
        });
    }
    document.getElementById('content').innerHTML=html;
}

// === MAP ===
let mapShowEnCamino=true,mapShowReprogramados=true,mapShowEntregados=true,leafletMap=null,markersLayer=null;
function toggleMapFilter(t){
    if(t==='en-camino'){mapShowEnCamino=!mapShowEnCamino;document.getElementById('mapFilterEnCamino').classList.toggle('on-camino',mapShowEnCamino)}
    else if(t==='reprogramado'){mapShowReprogramados=!mapShowReprogramados;document.getElementById('mapFilterReprogramado').classList.toggle('on-reprog',mapShowReprogramados)}
    else if(t==='entregado'){mapShowEntregados=!mapShowEntregados;document.getElementById('mapFilterEntregado').classList.toggle('on-entreg',mapShowEntregados)}
    actualizarMapa();
}
function mostrarMapa(){
    document.getElementById('mapCountEnCamino').textContent=allFlexOrders.filter(({shipping})=>{const s=getOrderState(shipping);return s==='pendiente'||s==='en-camino'}).length;
    document.getElementById('mapCountReprogramado').textContent=allFlexOrders.filter(({shipping})=>getOrderState(shipping)==='reprogramado').length;
    document.getElementById('mapCountEntregado').textContent=allFlexOrders.filter(({shipping})=>getOrderState(shipping)==='entregado').length;
    document.getElementById('mapModal').classList.add('open');document.body.style.overflow='hidden';
    if(!leafletMap){setTimeout(()=>{try{leafletMap=L.map('mapFrame').setView([-34.6037,-58.3816],11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM',maxZoom:19}).addTo(leafletMap);
        markersLayer=L.layerGroup().addTo(leafletMap);setTimeout(()=>{leafletMap.invalidateSize();actualizarMapa()},100)}catch(e){console.error(e)}},200)}
    else{setTimeout(()=>{leafletMap.invalidateSize();actualizarMapa()},100)}
}
function cerrarMapa(){document.getElementById('mapModal').classList.remove('open');document.body.style.overflow='auto'}
function actualizarMapa(){
    if(!leafletMap||!markersLayer)return;markersLayer.clearLayers();let bounds=[];
    allFlexOrders.filter(({shipping,cuentaNombre})=>{
        const s=getOrderState(shipping);if(s==='cancelado')return false;
        let pass=false;if(s==='pendiente'||s==='en-camino')pass=mapShowEnCamino;else if(s==='reprogramado')pass=mapShowReprogramados;else if(s==='entregado')pass=mapShowEntregados;
        if(!pass)return false;if(currentCuentaFilter!=='all'&&cuentaNombre!==currentCuentaFilter)return false;
        if(currentZoneFilter!=='all'){const z=getZonaDetallada(shipping.receiver_address?.neighborhood?.name||'',shipping.receiver_address?.city?.name||'',shipping.receiver_address?.zip_code||'');
            if(currentZoneFilter==='CABA'){if(!esCABA(z))return false}else{if(z!==currentZoneFilter)return false}}
        return true;
    }).forEach(({shipping,orders:oList,cuentaNombre})=>{
        const lat=shipping.receiver_address?.latitude,lng=shipping.receiver_address?.longitude;if(!lat||!lng)return;
        const s=getOrderState(shipping);const calle=shipping.receiver_address?.street_name||'';const num=shipping.receiver_address?.street_number||'';
        const ciudad=shipping.receiver_address?.city?.name||'';const barrio=shipping.receiver_address?.neighborhood?.name||'';
        const zona=getZonaDetallada(barrio,ciudad,shipping.receiver_address?.zip_code||'');
        const comp=oList[0]?.buyer?.nickname||'';const oid=oList[0]?.id||'';
        const dir=`${calle} ${num}, ${ciudad}`;const gmap=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dir)}`;
        let color='#a855f7',emoji='‚è≥',txt='Pendiente';
        if(s==='en-camino'){color='#22d3ee';emoji='üöö';txt='En camino'}
        else if(s==='entregado'){color='#34d399';emoji='‚úÖ';txt='Entregado'}
        else if(s==='reprogramado'){color='#fb923c';emoji='üîÑ';txt=getReprogramadoDetail(shipping).short}
        const icon=L.divIcon({className:'',html:`<div style="background:${color};width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.4)">${emoji}</div>`,iconSize:[28,28],iconAnchor:[14,14]});
        const m=L.marker([lat,lng],{icon});
        m.bindPopup(`<div style="min-width:180px;font-family:DM Sans,sans-serif;font-size:12px">
            <div style="margin-bottom:6px"><span style="background:${color};color:${s==='en-camino'||s==='entregado'||s==='reprogramado'?'#000':'#fff'};padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600">${emoji} ${txt}</span></div>
            <div style="font-weight:600;margin-bottom:4px">${zona}</div>
            <div style="color:#8e8e96;margin-bottom:4px">${comp}</div>
            <a href="${gmap}" target="_blank" style="color:#4a9eff;font-size:11px">${dir}</a>
        </div>`);
        m.addTo(markersLayer);bounds.push([lat,lng]);
    });
    if(bounds.length)leafletMap.fitBounds(bounds,{padding:[40,40]});
}

document.addEventListener('click',e=>{if(!e.target.closest('.zone-select-wrap')&&dropdownOpen)toggleDropdown()});

window.addEventListener('DOMContentLoaded',()=>{actualizarLabelDiaAnterior();cargarFlexHoy()});
</script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>
